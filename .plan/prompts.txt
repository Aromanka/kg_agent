>>> ç”Ÿæˆé¡¹ç›®ç›®æ ‡ - deepseek
ä½œä¸ºå¤§æ¨¡å‹+è½¯ä»¶å·¥ç¨‹å›¢é˜Ÿç­–åˆ’ï¼Œé¢å¯¹**ä¹™æ–¹éœ€æ±‚**ï¼ŒåŸºäº**æŠ€æœ¯è¦ç‚¹**ç»™å‡ºä¸€ä¸ªè¯¦ç»†åˆ°å®ç°æ–¹æ³•çš„ä»»åŠ¡ç›®æ ‡ï¼š

### ä¹™æ–¹éœ€æ±‚ï¼š
éœ€è¦æœ‰**diet_candidate_generator**(é¥®é£Ÿå€™é€‰æ–¹æ¡ˆç”Ÿæˆå™¨), **exer_candidate_generator**(è¿åŠ¨å€™é€‰æ–¹æ¡ˆç”Ÿæˆå™¨),**safeguard**(é£é™©è¯„ä¼°æ¨¡å—)ä¸‰ä¸ªåŸºäº{çŸ¥è¯†å›¾è°±, LLM, prompt_engineering, parser_rules}çš„æ¨¡å—ã€‚
å…¶ä¸­**diet_candidate_generator**, **exer_candidate_generator**ç”¨äºåœ¨é¥®é£Ÿ/è¿åŠ¨çŸ¥è¯†å›¾è°±æŒ‡å¯¼ä¸‹ç”Ÿæˆæ–¹æ¡ˆé‡‡æ ·ã€‚éšåæ–¹æ¡ˆä¼šç»è¿‡ä¸€ç³»åˆ—å¤„ç†å’Œå˜æ¢ï¼Œå†ç”±**safeguard**è¡¡é‡åè¾“å‡ºã€‚

æ–¹æ¡ˆç”Ÿæˆæ”¯æŒï¼š
1. æ ¹æ®ç”¨æˆ·metadataï¼ˆç”Ÿç†æŒ‡æ ‡ï¼‰ã€å½“å‰çš„ç¯å¢ƒå˜é‡ï¼ˆå¤©æ°”/æ—¥æœŸ/æ—¶é—´ï¼‰ç”Ÿæˆå¤šä¸ªå€™é€‰æ–¹æ¡ˆ
2. æ ¹æ®ç”¨æˆ·metadataï¼ˆç”Ÿç†æŒ‡æ ‡ï¼‰ã€å½“å‰çš„ç¯å¢ƒå˜é‡ï¼ˆå¤©æ°”/æ—¥æœŸ/æ—¶é—´ï¼‰ä¸ç”¨æˆ·çš„éœ€æ±‚ç”Ÿæˆå¤šä¸ªå€™é€‰æ–¹æ¡ˆ

é£é™©è¯„ä¼°æ¨¡å—æ”¯æŒï¼š
1. å¯¹äºç»™å‡ºçš„ç”¨æˆ·metadataï¼ˆç”Ÿç†æŒ‡æ ‡ï¼‰ã€å½“å‰çš„ç¯å¢ƒå˜é‡ï¼ˆå¤©æ°”/æ—¥æœŸ/æ—¶é—´ï¼‰å’Œå…·ä½“æ–¹æ¡ˆï¼Œè¾“å‡ºä¸€ä¸ª{0-100åˆ†çš„æ ‡é‡/True or Falseçš„åˆ¤æ–­}ï¼Œåˆ¤å®šæ–¹æ¡ˆæ˜¯å¦å®‰å…¨ã€‚

### æŠ€æœ¯åŸºç¡€å‚è€ƒä¸Šä¼ ä»£ç 

### ä»»åŠ¡ç›®æ ‡ï¼š
ä½œä¸ºå›¢é˜Ÿç­–åˆ’ï¼Œç»™å‡ºå›¢é˜Ÿå®ç°è¯¥é¡¹ç›®çš„milestoneè§„åˆ’ï¼ŒåŒ…å«æ•°æ®éœ€æ±‚ã€å¯æ¥å—çš„è¾“å…¥æ ¼å¼ã€prompt_engineeringå’Œå¯¹åº”parseréœ€è¦è¦†ç›–çš„ä»»åŠ¡ç±»å‹ï¼š

### æ–¹æ¡ˆï¼š
-------------- response
ä½œä¸ºå›¢é˜Ÿç­–åˆ’ï¼Œæˆ‘æå‡ºä»¥ä¸‹**åˆ†é˜¶æ®µå®æ–½çš„Milestoneè§„åˆ’**ï¼Œæ¶µç›–æŠ€æœ¯å®ç°è·¯å¾„ã€æ•°æ®éœ€æ±‚ä¸æ¥å£è®¾è®¡ï¼š

## ğŸ“Š **Milestone 1ï¼šéœ€æ±‚ç»†åŒ–ä¸åŸºç¡€è®¾æ–½æ­å»ºï¼ˆ2å‘¨ï¼‰**
### **æ•°æ®éœ€æ±‚**
1. **çŸ¥è¯†å›¾è°±æ•°æ®**
   - é¥®é£ŸçŸ¥è¯†å›¾è°±ï¼šé£Ÿç‰©è¥å…»æˆåˆ†è¡¨ï¼ˆè‡³å°‘1000ç§é£Ÿç‰©ï¼‰ã€é£Ÿç‰©æ­é…ç¦å¿Œã€ç–¾ç—…é¥®é£Ÿå»ºè®®
   - è¿åŠ¨çŸ¥è¯†å›¾è°±ï¼šè¿åŠ¨ç±»å‹åº“ã€è¿åŠ¨æ¶ˆè€—å¡è·¯é‡Œæ•°æ®ã€è¿åŠ¨é£é™©ç³»æ•°
   - å¥åº·æ ‡å‡†åº“ï¼šBMIæ ‡å‡†ã€è¡€å‹/è¡€ç³–æ ‡å‡†ã€å„ç–¾ç—…äººç¾¤å®‰å…¨é˜ˆå€¼

2. **ç¤ºä¾‹æ•°æ®**
   - ç”¨æˆ·metadataç¤ºä¾‹é›†ï¼š200+æ ‡æ³¨æ ·æœ¬
   - å®‰å…¨/ä¸å®‰å…¨æ–¹æ¡ˆæ ‡æ³¨æ•°æ®ï¼š500+å¯¹ï¼ˆæ–¹æ¡ˆ+å®‰å…¨è¯„åˆ†ï¼‰

### **è¾“å…¥æ ¼å¼æ ‡å‡†**
```json
{
  "user_metadata": {
    "age": 35,
    "gender": "male",
    "height_cm": 175,
    "weight_kg": 70,
    "bmi": 22.9,
    "medical_conditions": ["hypertension", "diabetes"],
    "dietary_restrictions": ["low_sodium", "low_sugar"],
    "fitness_level": "intermediate"
  },
  "environment": {
    "weather": {
      "condition": "rainy",
      "temperature_c": 18,
      "humidity_percent": 85,
      "aqi": 45
    },
    "time_context": {
      "date": "2024-03-15",
      "time_of_day": "morning",
      "season": "spring"
    }
  },
  "user_requirement": {  // å¯é€‰
    "goal": "weight_loss",
    "intensity": "moderate",
    "preferences": ["prefer_indoor", "vegetarian"]
  }
}
```

## ğŸš€ **Milestone 2ï¼šæ ¸å¿ƒæ¨¡å—åŸå‹å¼€å‘ï¼ˆ4å‘¨ï¼‰**
### **2.1 diet_candidate_generator**
#### **Prompt Engineeringè®¾è®¡**
```python
DIET_GENERATION_PROMPT = {
  "system_role": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è¥å…»å¸ˆï¼ŒåŸºäºçŸ¥è¯†å›¾è°±æ•°æ®ç”Ÿæˆä¸ªæ€§åŒ–çš„é¥®é£Ÿæ–¹æ¡ˆã€‚",
  "components": [
    {
      "name": "knowledge_retrieval",
      "prompt": "åŸºäºç”¨æˆ·ç–¾ç—…{medical_conditions}ï¼Œä»çŸ¥è¯†å›¾è°±ä¸­æ£€ç´¢å¿…é¡»éµå¾ªçš„é¥®é£ŸåŸåˆ™å’Œç¦å¿Œé£Ÿç‰©ã€‚"
    },
    {
      "name": "meal_generation",
      "prompt": "ç”Ÿæˆ{meal_count}ä¸ªå€™é€‰æ–¹æ¡ˆï¼Œæ¯ä¸ªæ–¹æ¡ˆåŒ…å«ï¼šæ—©é¤ã€åˆé¤ã€æ™šé¤ã€åŠ é¤ï¼Œå…·ä½“åˆ°é£Ÿç‰©ç§ç±»å’Œåˆ†é‡(g/ml)ã€‚è€ƒè™‘å­£èŠ‚{season}å’Œå¤©æ°”{weather_condition}çš„å½±å“ã€‚"
    },
    {
      "name": "nutrition_calculation",
      "prompt": "è®¡ç®—æ¯ä¸ªæ–¹æ¡ˆçš„æ€»çƒ­é‡ã€è›‹ç™½è´¨ã€ç¢³æ°´åŒ–åˆç‰©ã€è„‚è‚ªå«é‡ï¼Œç¡®ä¿ç¬¦åˆç”¨æˆ·{goal}ç›®æ ‡ã€‚"
    }
  ],
  "output_format": "è¿”å›JSONæ•°ç»„ï¼Œæ¯ä¸ªæ–¹æ¡ˆåŒ…å«meal_planã€total_caloriesã€macro_nutrientsã€safety_noteså­—æ®µ"
}
```

#### **Parser Rulesè¦†ç›–ç±»å‹**
1. **ç»“æ„åŒ–æå–**
   ```python
   class DietPlanParser:
     def parse_llm_output(self, text):
         # è§„åˆ™1ï¼šæå–JSONæ ¼å¼çš„æ–¹æ¡ˆæ•°æ®
         # è§„åˆ™2ï¼šéªŒè¯è¥å…»æˆåˆ†è®¡ç®—çš„åˆç†æ€§
         # è§„åˆ™3ï¼šæ£€æŸ¥é£Ÿç‰©ç¦å¿Œå†²çªï¼ˆè°ƒç”¨çŸ¥è¯†å›¾è°±éªŒè¯ï¼‰
         # è§„åˆ™4ï¼šç»Ÿä¸€è®¡é‡å•ä½è½¬æ¢
   ```

### **2.2 exer_candidate_generator**
#### **Prompt Engineeringè®¾è®¡**
```python
EXER_GENERATION_PROMPT = {
  "system_role": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¥èº«æ•™ç»ƒï¼Œè€ƒè™‘ç”¨æˆ·å¥åº·çŠ¶å†µå’Œç¯å¢ƒå› ç´ åˆ¶å®šè¿åŠ¨è®¡åˆ’ã€‚",
  "constraints": [
    "å¿…é¡»è€ƒè™‘ç”¨æˆ·çš„{fitness_level}æ°´å¹³",
    "åœ¨{weather_condition}å¤©æ°”ä¸‹æ¨èåˆé€‚çš„è¿åŠ¨ç±»å‹",
    "é¿å…ä¸{medical_conditions}å†²çªçš„è¿åŠ¨",
    "é€æ­¥å¢åŠ å¼ºåº¦çš„progressive_overloadåŸåˆ™"
  ],
  "generation_logic": "ä»{intensity_low}åˆ°{intensity_high}ç”Ÿæˆ3ä¸ªå¼ºåº¦ç­‰çº§çš„è¿åŠ¨æ–¹æ¡ˆ",
  "safety_checkpoints": ["å¿ƒç‡åŒºé—´æ§åˆ¶", "å…³èŠ‚è´Ÿè·è¯„ä¼°", "ç¯å¢ƒé€‚åº”æ€§"]
}
```

#### **Parser Rulesè¦†ç›–ç±»å‹**
1. **è¿åŠ¨æ–¹æ¡ˆè§£æ**
   ```python
   patterns = {
     'duration': r'(\d+)\s*(åˆ†é’Ÿ|min|å°æ—¶|hr)',
     'intensity': r'(ä½|ä¸­|é«˜|low|medium|high)å¼ºåº¦',
     'type': r'(æœ‰æ°§|åŠ›é‡|æŸ”éŸ§æ€§|å¹³è¡¡æ€§)è®­ç»ƒ'
   }
   ```

## ğŸ”§ **Milestone 3ï¼šé£é™©è¯„ä¼°æ¨¡å—å¼€å‘ï¼ˆ3å‘¨ï¼‰**
### **safeguardæ¨¡å—å®ç°æ–¹æ¡ˆ**
#### **åŒå±‚è¯„ä¼°æ¶æ„**
1. **è§„åˆ™å¼•æ“ï¼ˆç¡®å®šæ€§è¯„ä¼°ï¼‰**
   ```python
   class RuleBasedSafetyChecker:
     def check(self, plan, user_metadata):
         # è§„åˆ™1ï¼šçƒ­é‡æç«¯å€¼æ£€æŸ¥ï¼ˆ<800æˆ–>4000å¡è·¯é‡Œï¼‰
         # è§„åˆ™2ï¼šç–¾ç—…ç¦å¿ŒåŒ¹é…ï¼ˆçŸ¥è¯†å›¾è°±æŸ¥è¯¢ï¼‰
         # è§„åˆ™3ï¼šç¯å¢ƒé£é™©ï¼ˆé«˜æ¸©ä¸‹é«˜å¼ºåº¦è¿åŠ¨ï¼‰
         # è§„åˆ™4ï¼šè¥å…»å‡è¡¡æ€§æ£€æŸ¥
   ```

2. **LLMè¯­ä¹‰è¯„ä¼°ï¼ˆæ¦‚ç‡æ€§è¯„ä¼°ï¼‰**
   ```python
   SAFETY_PROMPT = """
   ä½œä¸ºåŒ»ç–—å®‰å…¨ä¸“å®¶ï¼Œè¯„ä¼°ä»¥ä¸‹æ–¹æ¡ˆçš„å®‰å…¨æ€§ï¼š
   ç”¨æˆ·çŠ¶å†µï¼š{medical_summary}
   æ–¹æ¡ˆè¯¦æƒ…ï¼š{plan_details}
   
   è¯·ä»ä»¥ä¸‹ç»´åº¦è¯„åˆ†ï¼ˆ0-100ï¼‰ï¼š
   1. ç–¾ç—…å…¼å®¹æ€§ï¼ˆæƒé‡40%ï¼‰
   2. å¼ºåº¦é€‚å®œæ€§ï¼ˆæƒé‡30%ï¼‰
   3. ç¯å¢ƒé€‚åº”æ€§ï¼ˆæƒé‡20%ï¼‰
   4. å¯æŒç»­æ€§ï¼ˆæƒé‡10%ï¼‰
   
   è¾“å‡ºæ ¼å¼ï¼š{"total_score": 85, "risk_factors": [...], "recommendations": [...]}
   """
   ```

#### **è¾“å‡ºæ ¼å¼**
```json
{
  "safety_assessment": {
    "score": 85,
    "is_safe": true,
    "risk_level": "low",
    "risk_factors": [
      {"factor": "high_intensity", "severity": "medium"},
      {"factor": "weather_risk", "severity": "low"}
    ],
    "confidence": 0.92,
    "threshold_used": 70
  }
}
```

## ğŸ“ˆ **Milestone 4ï¼šç³»ç»Ÿé›†æˆä¸ä¼˜åŒ–ï¼ˆ3å‘¨ï¼‰**
### **4.1 ç®¡é“é›†æˆè®¾è®¡**
```python
class HealthPlanPipeline:
    def generate_candidates(self, input_data):
        # æ­¥éª¤1ï¼šçŸ¥è¯†å›¾è°±æŸ¥è¯¢
        kg_context = self.query_knowledge_graph(input_data)
        
        # æ­¥éª¤2ï¼šå€™é€‰æ–¹æ¡ˆç”Ÿæˆ
        diet_candidates = diet_generator.generate(
            user_data=input_data,
            kg_context=kg_context,
            count=5  # ç”Ÿæˆ5ä¸ªå€™é€‰
        )
        
        # æ­¥éª¤3ï¼šå®‰å…¨è¿‡æ»¤
        safe_diets = []
        for plan in diet_candidates:
            score = safeguard.evaluate(plan, input_data)
            if score['is_safe']:
                safe_diets.append({
                    'plan': plan,
                    'safety_score': score['score']
                })
        
        # æ­¥éª¤4ï¼šæ’åºè¿”å›ï¼ˆå®‰å…¨æ€§>ä¸ªæ€§åŒ–åŒ¹é…åº¦ï¼‰
        return sorted(safe_diets, key=lambda x: x['safety_score'], reverse=True)[:3]
```

### **4.2 Prompt Engineeringè¦†ç›–ä»»åŠ¡ç±»å‹**
| ä»»åŠ¡ç±»å‹ | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹æ¨¡æ¿æ•° |
|---------|---------|-----------|
| **æ£€ç´¢å¢å¼ºç”Ÿæˆ** | çŸ¥è¯†å›¾è°±æŸ¥è¯¢+æ–¹æ¡ˆç”Ÿæˆ | 3å¥— |
| **çº¦æŸæ¡ä»¶æ³¨å…¥** | ç–¾ç—…é™åˆ¶ã€ç¯å¢ƒé™åˆ¶ | 5ç±»çº¦æŸæ¨¡æ¿ |
| **å¤šæ–¹æ¡ˆç”Ÿæˆ** | ä¸åŒå¼ºåº¦/åå¥½æ–¹æ¡ˆ | 2å¥—å˜ä½“ç­–ç•¥ |
| **å®‰å…¨è¯„ä¼°** | å¤šç»´é£é™©è¯„ä¼° | 4ç»´åº¦è¯„åˆ†æ¨¡æ¿ |
| **è§£é‡Šç”Ÿæˆ** | æ–¹æ¡ˆç†ç”±è¯´æ˜ | 1å¥—è§£é‡Šæ¨¡æ¿ |

### **4.3 Parser Rulesè¦†ç›–èŒƒå›´**
1. **ç»“æ„åŒ–æ•°æ®æå–**ï¼ˆJSON/YAMLæ ¼å¼ï¼‰
2. **è‡ªç„¶è¯­è¨€å…³é”®ä¿¡æ¯æŠ½å–**ï¼ˆå‰‚é‡ã€æ—¶é•¿ã€é¢‘ç‡ï¼‰
3. **æ•°å€¼èŒƒå›´éªŒè¯**ï¼ˆçƒ­é‡ã€æ—¶é•¿åœ¨åˆç†èŒƒå›´ï¼‰
4. **å•ä½æ ‡å‡†åŒ–**ï¼ˆç»Ÿä¸€åˆ°æ ‡å‡†å•ä½ï¼‰
5. **å†²çªæ£€æµ‹**ï¼ˆä¸çŸ¥è¯†å›¾è°±è§„åˆ™å†²çªï¼‰

## ğŸ§ª **Milestone 5ï¼šæµ‹è¯•ä¸éƒ¨ç½²ï¼ˆ2å‘¨ï¼‰**
### **éªŒæ”¶æ ‡å‡†**
1. **åŠŸèƒ½éªŒæ”¶**
   - æ¯ä¸ªæ¨¡å—ç‹¬ç«‹æµ‹è¯•é€šè¿‡ç‡ > 95%
   - ç«¯åˆ°ç«¯æµç¨‹æˆåŠŸç‡ > 90%
   - å“åº”æ—¶é—´ < 5ç§’

2. **è´¨é‡æŒ‡æ ‡**
   - å®‰å…¨è¯„ä¼°å‡†ç¡®ç‡ > 85%ï¼ˆå¯¹æ¯”ä¸“å®¶æ ‡æ³¨ï¼‰
   - ä¸ªæ€§åŒ–åŒ¹é…æ»¡æ„åº¦ > 80%ï¼ˆç”¨æˆ·è°ƒç ”ï¼‰
   - çŸ¥è¯†å›¾è°±è¦†ç›–ç‡ > 90%å¸¸è§åœºæ™¯

### **éƒ¨ç½²ç­–ç•¥**
```yaml
phase1:
  - æ¨¡å—: diet_candidate_generator
    deployment: é€æ­¥ä¸Šçº¿ï¼Œå…ˆæ”¯æŒå¸¸è§ç–¾ç—…
  - æ¨¡å—: safeguard
    deployment: ä¸¥æ ¼æ¨¡å¼å¯åŠ¨ï¼Œäººå·¥å®¡æ ¸é«˜é£é™©æ–¹æ¡ˆ
    
phase2:
  - å…¨æ¨¡å—è‡ªåŠ¨åŒ–è¿è¡Œ
  - å®æ—¶ç›‘æ§å®‰å…¨é¢„è­¦
```

## ğŸ“‹ **æ•°æ®ç®¡é“ä¾èµ–**
```
åŸå§‹æ•°æ® â†’ çŸ¥è¯†å›¾è°±æ„å»º â†’ å‘é‡åŒ–å­˜å‚¨
       â†“
ç”¨æˆ·è¾“å…¥ â†’ è¯­ä¹‰ç†è§£ â†’ å›¾è°±æŸ¥è¯¢ â†’ LLMç”Ÿæˆ â†’ è§£æéªŒè¯ â†’ å®‰å…¨è¯„ä¼° â†’ è¾“å‡º
```

## ğŸ¯ **å…³é”®æŠ€æœ¯å†³ç­–ç‚¹**
1. **LLMé€‰æ‹©**ï¼šåŸºäºæˆæœ¬/æ€§èƒ½æƒè¡¡é€‰æ‹©åŸºç¡€æ¨¡å‹
2. **çŸ¥è¯†å›¾è°±æ·±åº¦**ï¼šä»æ ¸å¿ƒ500èŠ‚ç‚¹å¼€å§‹ï¼ŒæŒ‰éœ€æ‰©å±•
3. **å®‰å…¨é˜ˆå€¼**ï¼šåˆå§‹è®¾ç½®ä¸º70åˆ†ï¼Œæ ¹æ®å®é™…æ•°æ®è°ƒæ•´
4. **fallbackæœºåˆ¶**ï¼šLLMå¤±è´¥æ—¶ä½¿ç”¨è§„åˆ™å¼•æ“ç”ŸæˆåŸºç¡€æ–¹æ¡ˆ

è¿™ä¸ªè§„åˆ’ç¡®ä¿äº†é¡¹ç›®ä»æ•°æ®å‡†å¤‡åˆ°éƒ¨ç½²çš„å®Œæ•´è·¯å¾„ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½æœ‰æ˜ç¡®çš„äº¤ä»˜ç‰©å’ŒéªŒè¯æ ‡å‡†ï¼ŒåŒæ—¶ä¿æŒäº†æŠ€æœ¯å®ç°çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚

>>> ç”Ÿæˆæå–ä¿¡æ¯çš„diet prompt - grok
ä¸ºäº†å®ç°å¦‚ä¸‹ç›®æ ‡ä¸­çš„diet_candidate_generatorï¼Œä¿®æ”¹ä¸Šä¼ ä»£ç ä¸­çš„SCHEMA_PROMPTï¼Œç”¨äºæå–é¥®é£ŸæŒ‡å—ã€‚

### ä»»åŠ¡ç›®æ ‡ï¼š
åŸºäº LLM+çŸ¥è¯†å›¾è°± çš„agenté¡¹ç›®ã€‚
éœ€è¦æœ‰**diet_candidate_generator**(é¥®é£Ÿå€™é€‰æ–¹æ¡ˆç”Ÿæˆå™¨), **exer_candidate_generator**(è¿åŠ¨å€™é€‰æ–¹æ¡ˆç”Ÿæˆå™¨),**safeguard**(é£é™©è¯„ä¼°æ¨¡å—)ä¸‰ä¸ªåŸºäº{çŸ¥è¯†å›¾è°±, LLM, prompt_engineering, parser_rules}çš„æ¨¡å—ã€‚
å…¶ä¸­**diet_candidate_generator**, **exer_candidate_generator**ç”¨äºåœ¨é¥®é£Ÿ/è¿åŠ¨çŸ¥è¯†å›¾è°±æŒ‡å¯¼ä¸‹ç”Ÿæˆæ–¹æ¡ˆé‡‡æ ·ã€‚éšåæ–¹æ¡ˆä¼šç»è¿‡ä¸€ç³»åˆ—å¤„ç†å’Œå˜æ¢ï¼Œå†ç”±**safeguard**è¡¡é‡åè¾“å‡ºã€‚

æ–¹æ¡ˆç”Ÿæˆæ”¯æŒï¼š
1. æ ¹æ®ç”¨æˆ·metadataï¼ˆç”Ÿç†æŒ‡æ ‡ï¼‰ã€å½“å‰çš„ç¯å¢ƒå˜é‡ï¼ˆå¤©æ°”/æ—¥æœŸ/æ—¶é—´ï¼‰ç”Ÿæˆå¤šä¸ªå€™é€‰æ–¹æ¡ˆ
2. æ ¹æ®ç”¨æˆ·metadataï¼ˆç”Ÿç†æŒ‡æ ‡ï¼‰ã€å½“å‰çš„ç¯å¢ƒå˜é‡ï¼ˆå¤©æ°”/æ—¥æœŸ/æ—¶é—´ï¼‰ä¸ç”¨æˆ·çš„éœ€æ±‚ç”Ÿæˆå¤šä¸ªå€™é€‰æ–¹æ¡ˆ

é£é™©è¯„ä¼°æ¨¡å—æ”¯æŒï¼š
1. å¯¹äºç»™å‡ºçš„ç”¨æˆ·metadataï¼ˆç”Ÿç†æŒ‡æ ‡ï¼‰ã€å½“å‰çš„ç¯å¢ƒå˜é‡ï¼ˆå¤©æ°”/æ—¥æœŸ/æ—¶é—´ï¼‰å’Œå…·ä½“æ–¹æ¡ˆï¼Œè¾“å‡ºä¸€ä¸ª{0-100åˆ†çš„æ ‡é‡/True or Falseçš„åˆ¤æ–­}ï¼Œåˆ¤å®šæ–¹æ¡ˆæ˜¯å¦å®‰å…¨ã€‚

>>> Improve Prompt - Gemini
Here is the completely overhauled `diet_kg.py`. This version implements the **Fix Plan** by expanding the schema to include demographic targeting, nutrient composition, and precise dosage handling. It also strictly enforces the JSON object structure to prevent API parsing errors.

### `diet_kg.py`

```python
"""
Diet Knowledge Graph Schema & Prompt Configuration
Revised to include Demographic Targeting, Composition, and Strict JSON Formatting.
"""

DIET_KG_EXTRACT_SCHEMA_PROMPT = """
ä½ æ˜¯å…¨çƒé¡¶å°–çš„è¥å…»å­¦ä¸å…¬å…±å«ç”ŸçŸ¥è¯†å›¾è°±æ„å»ºä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯ä»ç»™å®šçš„æ–‡æœ¬ä¸­**ç©·å°½å¼åœ°**æå–æ‰€æœ‰é¥®é£Ÿã€è¥å…»ä¸å¥åº·ç›¸å…³çš„å®ä½“å…³ç³»ä¸‰å…ƒç»„ã€‚

## âš ï¸ æ ¸å¿ƒæŒ‡ä»¤ (Critical Instructions)
1. **JSON Object å¼ºåˆ¶æ ¼å¼**ï¼šè¾“å‡ºå¿…é¡»æ˜¯ä¸€ä¸ªåŒ…å« "triplets" é”®çš„ JSON å¯¹è±¡ã€‚
2. **äººç¾¤ä¸å¥åº·å…¼é¡¾**ï¼šä¸ä»…è¦æå–é’ˆå¯¹**ç–¾ç—…**çš„å»ºè®®ï¼Œå¿…é¡»æå–é’ˆå¯¹**ç‰¹å®šäººç¾¤**ï¼ˆå¦‚å­•å¦‡ã€å„¿ç«¥ã€å¥åº·æˆäººï¼‰çš„å»ºè®®ã€‚
3. **å¤åˆå¥æ‹†è§£**ï¼šå¦‚æœä¸€å¥è¯åŒ…å«å¤šé‡ä¿¡æ¯ï¼ˆå¦‚"æ¯å¤©åƒ200gè”¬èœå¯é™ä½ç™Œç—‡é£é™©"ï¼‰ï¼Œå¿…é¡»æ‹†è§£ä¸ºæ‘„å…¥é‡ã€ç›Šå¤„ç­‰å¤šä¸ªä¸‰å…ƒç»„ã€‚
4. **æ ‡å‡†åŒ–**ï¼šæ•°å€¼ä¸å•ä½ç´§è´´ï¼ˆ200gï¼‰ï¼›å®ä½“åç§°å°½é‡è§„èŒƒåŒ–ï¼ˆä½¿ç”¨"äºŒç”²åŒèƒ"è€Œé"è¯¥è¯ç‰©"ï¼‰ã€‚

## ğŸ”— å…³ç³»å®šä¹‰ (Schema Definition)
è¯·ä¸¥æ ¼ä½¿ç”¨ä»¥ä¸‹ 12 ç§å…³ç³»ç±»å‹è¿›è¡Œæå–ï¼š

| å…³ç³»ç±»å‹ (Relation) | å®šä¹‰/è¯´æ˜ | Head (å¤´å®ä½“) | Tail (å°¾å®ä½“) | ç¤ºä¾‹ |
|-------------------|-----------|---------------|---------------|------|
| **Target_Recommendation** | é’ˆå¯¹ç‰¹å®šäººç¾¤çš„æ¨èï¼ˆåŒ…æ‹¬å¥åº·äººç¾¤ï¼‰ | äººç¾¤/äººå£ç»Ÿè®¡ | é£Ÿç‰©/è¥å…»ç´ /é¥®é£Ÿæ¨¡å¼ | å­•å¦‡ -> å¶é…¸ <br> 5å²ä»¥ä¸Šå„¿ç«¥ -> ç»´ç”Ÿç´ D |
| **Target_Avoid** | é’ˆå¯¹ç‰¹å®šäººç¾¤çš„ç¦å¿Œ/é™åˆ¶ | äººç¾¤/äººå£ç»Ÿè®¡ | é£Ÿç‰©/è¥å…»ç´ /é¥®é£Ÿæ¨¡å¼ | é«˜è¡€å‹æ‚£è€… -> é«˜é’ é£Ÿç‰© |
| **Disease_Management** | é¥®é£Ÿå¯¹ç–¾ç—…çš„ç›´æ¥ç®¡ç†/æ²»ç–—ä½œç”¨ | é¥®é£Ÿæ¨¡å¼/é£Ÿç‰© | ç–¾ç—…/ç—‡çŠ¶ | ä½ç¢³æ°´é¥®é£Ÿ -> 2å‹ç³–å°¿ç—… |
| **Nutrient_Content** | é£Ÿç‰©ä¸­åŒ…å«çš„è¥å…»æˆåˆ† | é£Ÿç‰© | è¥å…»ç´  | æ·±æµ·é±¼ -> Omega-3è„‚è‚ªé…¸ |
| **Has_Benefit** | æ‘„å…¥å¸¦æ¥çš„å…·ä½“å¥åº·ç›Šå¤„ | é£Ÿç‰©/è¥å…»ç´  | ç›Šå¤„/æ­£é¢æ•ˆæœ | è†³é£Ÿçº¤ç»´ -> æ”¹å–„æ¶ˆåŒ– |
| **Has_Risk** | æ‘„å…¥å¯èƒ½å¯¼è‡´çš„é£é™©æˆ–å‰¯ä½œç”¨ | é£Ÿç‰©/è¥å…»ç´  | é£é™©/è´Ÿé¢æ•ˆæœ/ç–¾ç—… | åå¼è„‚è‚ª -> å¿ƒè¡€ç®¡ç–¾ç—… |
| **Recommended_Intake** | æ¨èçš„æ‘„å…¥é‡ (Amount) | é£Ÿç‰©/è¥å…»ç´  | æ•°å€¼+å•ä½ | è”¬èœ -> 400g/d |
| **Recommended_Freq** | æ¨èçš„æ‘„å…¥é¢‘ç‡ (Frequency) | é£Ÿç‰©/è¥å…»ç´  | é¢‘ç‡æè¿° | é±¼ç±» -> æ¯å‘¨2æ¬¡ |
| **Max_Limit** | å»ºè®®çš„ä¸Šé™/é™åˆ¶é‡ | é£Ÿç‰©/è¥å…»ç´  | æ•°å€¼+å•ä½ | çº¢è‚‰ -> 70g/d |
| **Preparation_Method** | å»ºè®®çš„çƒ¹é¥ªæˆ–å‡†å¤‡æ–¹å¼ | é£Ÿç‰© | æ–¹æ³•/åŠ¨ä½œ | é¸¡è‚‰ -> å»çš® |
| **Interaction** | é£Ÿç‰©/è¥å…»ç´ ä¹‹é—´çš„ç›¸äº’ä½œç”¨ï¼ˆä¿ƒè¿›æˆ–æŠ‘åˆ¶ï¼‰ | å®ä½“A | å®ä½“B | ç»´ç”Ÿç´ C -> é“å¸æ”¶ |
| **Substitute_With** | æ¨èçš„æ›¿ä»£æ–¹æ¡ˆ | åŸé£Ÿç‰© | æ›¿ä»£é£Ÿç‰© | é»„æ²¹ -> æ©„æ¦„æ²¹ |

## ğŸ“ è¯¦ç»†æå–ç¤ºä¾‹ (Few-Shot Examples)

### ç¤ºä¾‹ 1ï¼šå…¬å…±å«ç”ŸæŒ‡å—ï¼ˆå«äººç¾¤ã€å‰‚é‡ã€æ›¿ä»£ï¼‰
**è¾“å…¥**ï¼š
"å»ºè®®æ‰€æœ‰1å²ä»¥ä¸Šçš„å¹¼å„¿æ¯å¤©é¥®ç”¨å…¨è„‚ç‰›å¥¶ã€‚æˆå¹´äººåº”é™åˆ¶çº¢è‚‰æ‘„å…¥ï¼ˆæ¯å¤©ä¸è¶…è¿‡70gï¼‰ï¼Œå¹¶ç”¨è±†ç±»æˆ–é±¼ç±»æ›¿ä»£åŠ å·¥è‚‰ç±»ä»¥é™ä½å¿ƒè„ç—…é£é™©ã€‚"

**è¾“å‡º**ï¼š
```json
{
  "triplets": [
    {"head": "1å²ä»¥ä¸Šå¹¼å„¿", "relation": "Target_Recommendation", "tail": "å…¨è„‚ç‰›å¥¶"},
    {"head": "æˆå¹´äºº", "relation": "Target_Avoid", "tail": "çº¢è‚‰"},
    {"head": "çº¢è‚‰", "relation": "Max_Limit", "tail": "70g/d"},
    {"head": "è±†ç±»", "relation": "Substitute_With", "tail": "åŠ å·¥è‚‰ç±»"},
    {"head": "é±¼ç±»", "relation": "Substitute_With", "tail": "åŠ å·¥è‚‰ç±»"},
    {"head": "è±†ç±»", "relation": "Has_Benefit", "tail": "é™ä½å¿ƒè„ç—…é£é™©"},
    {"head": "é±¼ç±»", "relation": "Has_Benefit", "tail": "é™ä½å¿ƒè„ç—…é£é™©"}
  ]
}

```

### ç¤ºä¾‹ 2ï¼šè¥å…»æ„æˆä¸ç‰¹å®šæ¡ä»¶

**è¾“å…¥**ï¼š
"æ©™å­å¯Œå«ç»´ç”Ÿç´ Cï¼Œæœ‰åŠ©äºé“çš„å¸æ”¶ã€‚ä½†åœ¨æœç”¨æŸäº›æŠ—ç”Ÿç´ æœŸé—´åº”é¿å…å¤§é‡é£Ÿç”¨é…¸æ€§æ°´æœã€‚"

**è¾“å‡º**ï¼š

```json
{
  "triplets": [
    {"head": "æ©™å­", "relation": "Nutrient_Content", "tail": "ç»´ç”Ÿç´ C"},
    {"head": "ç»´ç”Ÿç´ C", "relation": "Has_Benefit", "tail": "é“çš„å¸æ”¶"},
    {"head": "ç»´ç”Ÿç´ C", "relation": "Interaction", "tail": "é“"},
    {"head": "æœç”¨æŠ—ç”Ÿç´ äººç¾¤", "relation": "Target_Avoid", "tail": "é…¸æ€§æ°´æœ"},
    {"head": "æ©™å­", "relation": "Target_Avoid", "tail": "æœç”¨æŠ—ç”Ÿç´ äººç¾¤"} 
  ]
}

```

## ğŸ› ï¸ è¾“å‡ºè¦æ±‚

1. ä»…è¾“å‡º JSON å¯¹è±¡ã€‚
2. ç¡®ä¿ JSON åˆæ³•ï¼Œä¸è¦åŒ…å« Markdown ä»£ç å—æ ‡è®°ï¼ˆå¦‚ ```jsonï¼‰ã€‚
3. å¦‚æœæ–‡æœ¬ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¾“å‡º `{"triplets": []}`ã€‚
4. æ‰€æœ‰çš„ "head" å’Œ "tail" å¿…é¡»æ˜¯æ–‡æœ¬ä¸­å‡ºç°çš„å®ä½“æˆ–å…¶è§„èŒƒåŒ–åç§°ã€‚
"""

# æœ‰æ•ˆå…³ç³»åˆ—è¡¨ï¼ˆç”¨äºåå¤„ç†éªŒè¯ï¼‰

DIET_VALID_RELS = [
"Target_Recommendation",
"Target_Avoid",
"Disease_Management",
"Nutrient_Content",
"Has_Benefit",
"Has_Risk",
"Recommended_Intake",
"Recommended_Freq",
"Max_Limit",
"Preparation_Method",
"Interaction",
"Substitute_With"
]

```

### Key Changes Explained:

1.  **Added `Target_Recommendation` & `Target_Avoid`**:
    * **Why**: Specifically addresses the failure to capture "Healthy People" guidelines found in your `output.txt` (e.g., "Everyone aged five years..."). Now, "Pregnant Women" or "Adults" are valid Head Entities.
2.  **Added `Nutrient_Content`**:
    * **Why**: Your source text discusses food composition (e.g., "Oily fish includes salmon..."). This allows the graph to "know" that Salmon contains specific nutrients if mentioned.
3.  **Refined Logic for Amounts**:
    * Split into `Recommended_Intake` (Target to hit) and `Max_Limit` (Ceiling). This is crucial for dietary advice where "Eat at least X" vs "Eat no more than Y" has very different medical implications.
4.  **Strict JSON Wrapper**:
    * The prompt now explicitly demands the `{"triplets": [...]}` format. This solves the parsing error in your `build_kg_deepseek.py` where the API expects an object but the prompt was returning a list.
5.  **Preparation Methods**:
    * [cite_start]Added `Preparation_Method` to capture instructions like "leaving skins on potatoes" or "grill instead of fry" found in your source text[cite: 26, 37].

```