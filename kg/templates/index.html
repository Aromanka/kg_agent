<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>健康知识图谱问答系统</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: #f5f7fa; height: 100vh; display: flex; }
        .sidebar { width: 280px; background: linear-gradient(180deg, #1a73e8 0%, #1557b0 100%); color: white; padding: 20px; display: flex; flex-direction: column; }
        .sidebar h1 { font-size: 18px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .entity-section { flex: 1; }
        .entity-section label { display: block; font-size: 12px; opacity: 0.8; margin-bottom: 5px; }
        .entity-section input { width: 100%; padding: 10px; border: none; border-radius: 6px; background: rgba(255,255,255,0.15); color: white; font-size: 14px; margin-bottom: 10px; }
        .entity-section button { width: 100%; padding: 10px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-size: 14px; margin-bottom: 15px; }
        .entity-section button:hover { background: rgba(255,255,255,0.3); }
        .entity-section input::placeholder { color: rgba(255,255,255,0.6); }
        .main { flex: 1; display: flex; flex-direction: column; padding: 20px; gap: 20px; }
        .chat-section { height: 45%; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column; overflow: hidden; }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: 500; color: #333; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; }
        .message { margin-bottom: 15px; max-width: 80%; }
        .message.user { margin-left: auto; }
        .message .bubble { padding: 12px 16px; border-radius: 12px; font-size: 14px; line-height: 1.5; }
        .message.user .bubble { background: #1a73e8; color: white; border-bottom-right-radius: 4px; }
        .message.assistant .bubble { background: #f1f3f4; color: #333; border-bottom-left-radius: 4px; }
        .chat-input { padding: 15px 20px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .chat-input input { flex: 1; padding: 12px 16px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
        .chat-input input:focus { border-color: #1a73e8; }
        .chat-input button { padding: 12px 24px; background: #1a73e8; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .chat-input button:hover { background: #1557b0; }
        .graph-section { height: 50%; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column; min-height: 300px; }
        .graph-header { padding: 12px 20px; border-bottom: 1px solid #eee; font-weight: 500; font-size: 14px; color: #333; }
        #graphChart { flex: 1; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h1>健康知识图谱</h1>
        <div class="entity-section">
            <label>实体名称</label>
            <input type="text" id="entityName" placeholder="如：高血压、糖尿病...">
            <button onclick="loadGraph()">加载知识图谱</button>
        </div>
    </div>
    <div class="main">
        <div class="chat-section">
            <div class="chat-header">智能问答</div>
            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <div class="bubble">您好！我是健康知识图谱助手。请输入您想了解的医学问题，我会基于知识图谱为您解答。</div>
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="questionInput" placeholder="输入您的问题，如：高血压患者应该吃什么？">
                <button onclick="sendMessage()">发送</button>
            </div>
        </div>
        <div class="graph-section">
            <div class="graph-header">知识图谱可视化</div>
            <div id="graphChart"></div>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const questionInput = document.getElementById('questionInput');
        const entityName = document.getElementById('entityName');
        let chart = echarts.init(document.getElementById('graphChart'));

        function addMessage(content, isUser = false) {
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user' : 'assistant'}`;
            div.innerHTML = `<div class="bubble">${content}</div>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const question = questionInput.value.trim();
            if (!question) return;

            addMessage(question, true);
            questionInput.value = '';

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ entity_name: entityName.value, question })
                });
                const data = await res.json();
                addMessage(data.reply || '暂无相关回答');
            } catch (e) {
                addMessage('请求失败，请检查服务器');
            }
        }

        entityName.addEventListener('keypress', e => { if (e.key === 'Enter') loadGraph(); });

        async function loadGraph() {
            const name = entityName.value.trim();
            if (!name) {
                alert('请输入实体名称');
                return;
            }

            try {
                const res = await fetch(`/api/graph?entity_name=${encodeURIComponent(name)}`);
                const data = await res.json();
                if (data.nodes && data.nodes.length > 0) {
                    renderGraph(data);
                    addMessage(`已加载「${name}」的知识图谱`);
                } else {
                    addMessage(`未找到「${name}」相关的知识图谱数据`);
                }
            } catch (e) {
                console.error('Graph load failed:', e);
                addMessage('加载图谱失败，请检查服务器');
            }
        }

        function renderGraph(data) {
            console.log('Graph data:', data);

            const nodes = data.nodes.map(n => ({
                name: n.name,
                category: n.category,
                symbolSize: n.symbolSize || 40
            }));

            // Fix: properly set edge labels - use 'name' field for ECharts edge labels
            const links = data.links.map(l => ({
                source: l.source,
                target: l.target,
                label: {
                    show: true,
                    formatter: (l.value || l.name || '').replace('\n', ' '),
                    fontSize: 11,
                    color: '#666'
                }
            }));

            const categories = [{ name: '核心实体' }, { name: '关联实体' }];

            chart.setOption({
                tooltip: { formatter: '{b}' },
                legend: { data: ['核心实体', '关联实体'], bottom: 5 },
                series: [{
                    type: 'graph',
                    layout: 'force',
                    data: nodes,
                    links: links,
                    categories: categories,
                    roam: true,
                    draggable: true,
                    label: { show: true, fontSize: 12 },
                    force: {
                        repulsion: 400,
                        edgeLength: 150,
                        gravity: 0.1
                    },
                    lineStyle: {
                        color: 'source',
                        curveness: 0.1
                    },
                    edgeSymbol: ['none', 'arrow'],
                    edgeSymbolSize: 10
                }]
            });
        }

        window.addEventListener('resize', () => chart.resize());
        questionInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>
